«IMPORT guigen»

«IMPORT template::struts2::actionImplJavaFiles»
«IMPORT template::struts2::security»
«IMPORT template::struts2::typeConversion»
«EXTENSION template::GenericExtensions»
«EXTENSION template::struts2::Struts2Extensions»


«DEFINE javaFiles(boolean skip_component_dir_creation) FOR GUIModel»
	«EXPAND applicationConstantsJavaFile(skip_component_dir_creation) FOR this»
	«EXPAND struts2BaseActionJavaFile(skip_component_dir_creation) FOR this»
	«EXPAND struts2MenuJavaFile(skip_component_dir_creation) FOR this»
	«EXPAND struts2HomeJavaFile(skip_component_dir_creation) FOR this»
	«EXPAND struts2LogoutJavaFile(skip_component_dir_creation) FOR this»
	«EXPAND template::struts2::actionImplJavaFiles::actionImplClasses FOR this»
	«EXPAND template::struts2::modelJavaFiles::modelClasses FOR this»
	«EXPAND template::struts2::modelJavaFiles::springBEClasses FOR this»
	«EXPAND strutsCustomValidatorsJavaFiles(skip_component_dir_creation) FOR this»
	«EXPAND strutsCustomDecoratorsJavaFiles(skip_component_dir_creation) FOR this»
	«EXPAND security::securityJavaFiles(skip_component_dir_creation) FOR this»
	«EXPAND typeConversion::conversionClassesFiles(skip_component_dir_creation) FOR this»
«ENDDEFINE»


«REM»
==========================================================================================================================
STRUTS2 BASE FILES
===========================================================================================================================
«ENDREM»

«REM»Crea una Base action«ENDREM»
«DEFINE applicationConstantsJavaFile(boolean skip_component_dir_creation) FOR GUIModel»
«FILE getBaseJavaSrcDir(this, skip_component_dir_creation) + "/util/Constants.java" »package «getBaseJavaPackage(this)».util;

/**
 * <p>Classe delle costanti applicative.</p>
 *
 * @author GuiGen
 */
public final class Constants
{
    /**
     * identificativo dell'applicativo.
     */
    public static final String APPLICATION_CODE = "«codComponente»";
    
    «PROTECT CSTART '/*' CEND '*/' ID getRegionUID("Constants")»
    // Add here your constants
    «ENDPROTECT»
}

«ENDFILE»
«ENDDEFINE»


«REM»
Genera una Base Action Struts2 che contiene gli elementi comuni all'applicazione.
Tutte le altre Action dell'applicazione dovranno ereditare da questa
in modo da ottenere le parti comuni, e dovranno implementare in proprio
le funzionalità specifiche della pagina.
«ENDREM»
«DEFINE struts2BaseActionJavaFile(boolean skip_component_dir_creation) FOR GUIModel»
«FILE getStrutsBaseActionJavaFile(this, skip_component_dir_creation)»package «getPresentationJavaPackage(this)»;

import java.util.*;
import java.beans.BeanInfo;
import java.beans.IntrospectionException;
import java.beans.PropertyDescriptor;

import org.apache.log4j.Logger;
import com.opensymphony.xwork2.Preparable;
import org.apache.struts2.interceptor.SessionAware;

import com.opensymphony.xwork2.ActionSupport;

import «getBaseJavaPackage(this)».util.*;
import «getDTOBaseJavaPackage(this)».*;
import «getBaseJavaPackage()».business.*;
«IF ((GUIModel)(this.eRootContainer)).securityModel!=null-»
import «getSecurityJavaPackage(this)».*;
«ENDIF-»

/**
 * Base Action che contiene gli elementi comuni all'applicazione.
 * Tutte le altre Action dell'applicazione dovranno ereditare da questa
 * in modo da ottenere le parti comuni, e dovranno implementare in proprio
 * le funzionalit&agrave; specifiche della pagina.
 * <p/>
 * La classe eredita da {@link com.opensymphony.xwork2.ActionSupport} i
 * metodi di utilit&agrave; necessari ad eseguire le principali operazioni
 * (ad esempio conversione, validazione, ecc...) ed implementa l'interfaccia
 * {@link org.apache.struts2.interceptor.SessionAware}, che permette
 * alla Action di accedere alla sessione. 
 * 
 * @author GuiGen
 */
public abstract class «getStrutsBaseActionClassName(this)» extends ActionSupport implements SessionAware, Preparable {

	/**  */
	protected static Logger log = Logger.getLogger(Constants.APPLICATION_CODE + ".presentation");

	/** Riferimento alla sessione corrente */
	protected Map session;

	public void setSession(Map session) {
		this.session = session;
	}
	public Map getSession() {
		return this.session;
	}

	«IF securityModel.autenticationMethod!=null»
	protected Map<String, UISecConstraint> allMenuVisibilityConstraints = null;
	protected Map<String, UISecConstraint> allMenuOnOffConstraints = null;
	«ENDIF»
	
	
	public void prepare() throws Exception{
	«IF securityModel.autenticationMethod!=null»
	    // caricamento struttura di constraints
	    if (allMenuVisibilityConstraints==null)
	    	allMenuVisibilityConstraints = getMenuVisibilityUIConstraints();
	    if (allMenuOnOffConstraints==null)
	    	allMenuOnOffConstraints = getMenuONOFFUIConstraints();
	«ENDIF»
	}
	
    ////////////////////////////////////////////////////////////////////////
    //// costruzione/lettura strato model da passare allo strato di logica
    ////////////////////////////////////////////////////////////////////////
    public abstract Class modelClass();
    
	private java.lang.reflect.Method findReadMethod(String name, Class cl)
			throws IntrospectionException {
		name=(name.startsWith("get")||name.startsWith("set") ? name.substring(3)
			:
			name.startsWith("is")? name.substring(2) : name);
		BeanInfo bi = java.beans.Introspector.getBeanInfo(cl);
		PropertyDescriptor[] pds = bi.getPropertyDescriptors();
		for (int i = 0; i < pds.length; i++) {
			PropertyDescriptor currPd = pds[i];
			if (currPd.getName().equalsIgnoreCase(name))
				return currPd.getReadMethod();
		}
		return null;
	}

	private java.lang.reflect.Method findWriteMethod(String name, Class cl)
			throws IntrospectionException {
		name=(name.startsWith("get")||name.startsWith("set") ? name.substring(3)
			:
			name.startsWith("is")? name.substring(2) : name);
		BeanInfo bi = java.beans.Introspector.getBeanInfo(cl);
		PropertyDescriptor[] pds = bi.getPropertyDescriptors();
		for (int i = 0; i < pds.length; i++) {
			PropertyDescriptor currPd = pds[i];
			if (currPd.getName().equalsIgnoreCase(name))
				return currPd.getWriteMethod();
		}
		return null;
	}

	public Object toModel() {
		try {
			Object modelObj = modelClass().newInstance();
			// imposto prima di tutto la session per evitare errori nei setter
			// degli oggetti a scope Session
			((BaseSessionAwareDTO)modelObj).setSession(this.getSession());
			BeanInfo targetBI = java.beans.Introspector
					.getBeanInfo(modelClass());
			PropertyDescriptor[] targetPds = targetBI.getPropertyDescriptors();
			for (int i = 0; i < targetPds.length; i++) {
				PropertyDescriptor currTargetPD = targetPds[i];
				java.lang.reflect.Method srcReadMethod = findReadMethod(currTargetPD.getReadMethod().getName(),this.getClass());
				if (srcReadMethod != null) {
					Object srcVal = srcReadMethod.invoke(this, new Object[]{});
					java.lang.reflect.Method currWriteMethod = currTargetPD.getWriteMethod();
					if (currWriteMethod!=null){
						currTargetPD.getWriteMethod().invoke(modelObj,
								new Object[]{srcVal});
					}
				}
			}
			return modelObj;
		} catch (Exception e) {
			log.error("[«getStrutsBaseActionClassName(this)»::toModel] Errore interno nella costruzione del modello, classe:"
							+ modelClass() + ": " + e, e);
			throw new IllegalArgumentException(
					"Errore interno nella costruzione del modello, classe:"
							+ modelClass() + ": " + e);

		}
	}
    
    public void fromModel(Object modelObj) {
		try {
			BeanInfo srcBI = java.beans.Introspector.getBeanInfo(modelClass());
			PropertyDescriptor[] srcPds = srcBI.getPropertyDescriptors();
			for (int i = 0; i < srcPds.length; i++) {
				PropertyDescriptor currSrcPD = srcPds[i];
				java.lang.reflect.Method srcReadMethod = currSrcPD
						.getReadMethod();
				if (srcReadMethod != null) {
					Object srcVal = srcReadMethod.invoke(modelObj,
							new Object[]{});
					java.lang.reflect.Method targetWriteMethod = findWriteMethod(
							currSrcPD.getReadMethod().getName(), this
									.getClass());
					if (targetWriteMethod!=null){
						targetWriteMethod.invoke(this, new Object[]{srcVal});
					}
				}
			}
		} catch (Exception e) {
			log.error("[«getStrutsBaseActionClassName(this)»::fromModel] Errore interno nella costruzione del modello, classe:"
							+ modelClass() + ": " + e, e);
			throw new IllegalArgumentException(
					"Errore interno nella costruzione del modello, classe:"
							+ modelClass() + ": " + e);

		}
	}
    
    
	///////////////////////////////////
	/**
	 * Metodi per visibilita'/abilitazione
	 */
	

	/**
	 * @return true se il widget deve essere reso visibile
	 */
	public boolean isWidgetVisible(String cpName, String widgShortName){
		Map cpData = (Map)session.get(cpName);
		if (cpData!=null){
			Boolean visibleFlag=(Boolean)cpData.get(widgShortName+"_visible");
			if (visibleFlag!=null){
				return visibleFlag.booleanValue();
			}
			else
				return true;
		}
		else
			return true;
		
	}
	
	/**
	 * @return true se il widget deve essere disabilitato
	 */
	public boolean isWidgetDisabled(String cpName, String widgShortName){
		Map cpData = (Map)session.get(cpName);
		if (cpData!=null){
			Boolean enabledFlag=(Boolean)cpData.get(widgShortName+"_enabled");
			if (enabledFlag!=null){
				return !enabledFlag.booleanValue();
			}
			else
				return false;
		}
		else
			return false;
		
	}

	/**
	 * @return true se il menu/menuItem deve essere reso visibile
	 */
	public boolean isMenuVisible(String menuName) {
	«IF securityModel!=null-»
		UISecConstraint ctr = allMenuVisibilityConstraints.get(menuName);
		boolean status;
		if (ctr!=null){
			try{
				status = ctr.verifyConstraint(session, UISecConstraint.VISIB_CONSTRAINED_BEHAVIOR, getSpringSecurityHelper());
			}
			catch(BEException ex){
				log.error("[«getStrutsBaseActionClassName(this)»::isMenuVisible] errore durante verifica->false");
				return false;
			}
		}
		else
			status = true;
		return status;
	«ELSE-»
		return true;
	«ENDIF-»
	}

	/**
	 * @return true se il menu/menuItem deve essere reso abilitato
	 */
	public boolean isMenuEnabled(String menuName) {
	«IF securityModel!=null-»
		UISecConstraint ctr = allMenuOnOffConstraints.get(menuName);
		boolean status;
		if (ctr!=null){
			try{
				status = ctr.verifyConstraint(session, UISecConstraint.ONOFF_CONSTRAINED_BEHAVIOR, getSpringSecurityHelper());
			}
			catch(BEException ex){
				log.error("[«getStrutsBaseActionClassName(this)»::isMenuEnabled] errore durante verifica->false");
				return false;
			}
		}
		else
			status = true;
		return status;
	«ELSE»
		return true;
	«ENDIF»
	}
	
	/**
	 * @return true se il menu/menuItem deve essere reso attivo (ovvero &grave; stato cliccato)
	 */
	public boolean isMenuActive(String menuName) {
		String menu = "menu_items_" + menuName;
		return menu.equals((String)session.get("active_menu"));
	}


	/**
     * Gestione del reset della paginazione/sorting delle tabelle (Displaytag)
     * @param tableName nome della tabella
     * @return true se bisogna resettare paginazione/sorting, false altrimenti
     */
    public boolean isTableClearStatus(String tableName) {
    	String sessionValue = tableName + "_clearStatus";
    	Boolean clearStatus = (Boolean)session.get(sessionValue);
    	if ( clearStatus == null ) {
    		clearStatus = true;
    	}
    	if ( clearStatus ) {
    		// la proprieta' e' "usa e getta"
    		session.put(sessionValue, new Boolean(false));
    	}
    	return clearStatus;
    }
	

	«EXPAND actionImplJavaFiles::springBEProperties FOR this»
	
	«IF securityModel!=null && structure.appWindow.appArea.menubar!=null»
	«EXPAND security::getMenuUIConstraintDef(this) FOR structure.appWindow.appArea.menubar»
	«ENDIF»
}
«ENDFILE»
«ENDDEFINE»


«REM»Genera una Action Struts2 per mappare il menu.«ENDREM»
«DEFINE struts2MenuJavaFile(boolean skip_component_dir_creation) FOR GUIModel»
«FILE getStrutsMenuJavaFile(this, skip_component_dir_creation)»package «getPresentationJavaPackage(this)»;

import java.util.*;

import org.apache.struts2.interceptor.validation.SkipValidation;

import com.opensymphony.xwork2.validator.annotations.*;

import «getDTOBaseJavaPackage(this)».*;
import «getBaseJavaPackage()».business.*;

/**
 * «getStrutsMenuClassName(this)» Action Class.
 *
 * @author GuiGen
 */
@Validation()
public class «getStrutsMenuClassName(this)» extends «getStrutsBaseActionClassName(this)» {

	«EXPAND actionImplJavaFiles::storedAppDataProperties(this) FOR this.structure.appWindow.appArea.menubar»
	
	
	/**
	 * classe model associata
	 */
	public Class modelClass(){
		return «getModelDTOFQN(null, true, false, this)».class;
	}
	 
	/**
	 *
	 * @return Il risultato delle azioni, SUCCESS altrimenti.
	 */
	@SkipValidation
	public String execute() throws Exception {
		return SUCCESS;
	}

	«FOREACH this.structure.appWindow.appArea.menubar.topLevelMenu AS tlmenu»
		«IF tlmenu.eventHandler!=null»
	/**
	 * 
	 * @return SUCCESS result.
	 */
	public String goTo«tlmenu.name.toFirstUpper()»() throws Exception{
	    
		// gestione degli eventi di tipo CLICKED
		ICommand action = initCommand("«tlmenu.name»","CLICKED");
		String result = action.doCommand(this);
		if (result != null) {
			if (log.isDebugEnabled()){
				log.debug("[«getStrutsMenuClassName(this)»::goTo«tlmenu.name.toFirstUpper()»] returning result [" + result + "]");
			}
			setActiveMenu("«tlmenu.name»");
			return result;
		} else {
			if (log.isDebugEnabled()){
				log.debug("[«getStrutsMenuClassName(this)»::goTo«tlmenu.name.toFirstUpper()»] returning default result [SUCCESS]");
			}
			setActiveMenu("«tlmenu.name»");
			return SUCCESS;
		}
	}		
		«ENDIF»
		«FOREACH getAllMenuItemRecursive(tlmenu) AS currMenuItem»
		«IF ((MenuItem)currMenuItem).eventHandler.eventType == EventTypes::CLICKED»
		«LET ((MenuItem)currMenuItem).eventHandler.command AS currAction»
	/**
	 * 
	 * @return SUCCESS result.
	 */
	public String goTo«((MenuItem)currMenuItem).name.toFirstUpper()»() throws Exception{
	    
		// gestione degli eventi di tipo CLICKED
		ICommand action = initCommand("«((MenuItem)currMenuItem).name»","CLICKED");
		String result = action.doCommand(this);
		if (result != null) {
			if (log.isDebugEnabled()){
				log.debug("[«getStrutsMenuClassName(this)»::goTo«((MenuItem)currMenuItem).name.toFirstUpper()»] returning result [" + result + "]");
			}
			setActiveMenu("«((MenuItem)currMenuItem).name»");
			return result;
		} else {
			if (log.isDebugEnabled()){
				log.debug("[«getStrutsMenuClassName(this)»::goTo«((MenuItem)currMenuItem).name.toFirstUpper()»] returning default result [SUCCESS]");
			}
			setActiveMenu("«((MenuItem)currMenuItem).name»");
			return SUCCESS;
		}
	}

		«ENDLET»
		«ENDIF»
		«ENDFOREACH»
	«ENDFOREACH»

    public static final String ACTIVE_MENU_ATTRNAME = "active_menu";
    
	public void setActiveMenu(String menuName){
		session.put(ACTIVE_MENU_ATTRNAME, "menu_items_" + menuName);
	}
	
    «EXPAND actionImplJavaFiles::actionStructureInit(this) FOR this.structure.appWindow.appArea.menubar»
    
    
   	/**
	 * Gestione della validazione
	 */
	public void validate() {
		«PROTECT CSTART '/*' CEND '*/' ID getRegionUID(getStrutsMenuClassName(this) + "_validate")»
		/* Inserire la validazione */
		«ENDPROTECT»
	}
    
}
«ENDFILE»
«ENDDEFINE»


«REM»Genera la Action di Struts che gestisce la Home Page«ENDREM»
«DEFINE struts2HomeJavaFile(boolean skip_component_dir_creation) FOR GUIModel»
«FILE getStrutsHomeJavaFile(this, skip_component_dir_creation)»package «getPresentationJavaPackage(this)»;

import java.util.*;

import org.apache.struts2.interceptor.validation.SkipValidation;

import com.opensymphony.xwork2.validator.annotations.*;

import «getDTOBaseJavaPackage(this)».*;

/**
 * «getStrutsHomeClassName(this)» Action Class.
 *
 * @author GuiGen
 */
@Validation()
public class «getStrutsHomeClassName(this)» extends «getStrutsBaseActionClassName(this)» {

	«IF this.structure.appWindow.appArea.onInitCommand != null»
    «EXPAND actionImplJavaFiles::storedAppDataProperties(this) FOR this.structure.appWindow.appArea.onInitCommand»
    «ENDIF»
    
    /**
	 * classe model associata
	 */
	public Class modelClass() {
		«IF this.structure.appWindow.appArea.onInitCommand != null»
		return «getModelDTOFQN(null, false, true, this)».class;
		«ELSE»
		return java.lang.Object.class;
		«ENDIF»
	}
    
    
    «IF this.structure.appWindow.appArea.onInitCommand != null»
	/**
	 *
	 * @return Il risultato delle azioni, SUCCESS altrimenti.
	 */
	public String execute() throws Exception {
		
		log.debug("[«getStrutsHomeClassName(this)»::execute] START");
		
		ICommand action = initCommand();
		String result = action.doCommand(this);
		if (result != null) {
			return result;
		} else {
			log.debug("[«getStrutsHomeClassName(this)»::execute] END");
			return SUCCESS;
		}
	}
	«ENDIF»


	/**
	 * Gestione della validazione
	 */
	public void validate() {
		«PROTECT CSTART '/*' CEND '*/' ID getRegionUID(getStrutsHomeClassName(this) + "_validate")»
		/* Inserire la validazione */
		«ENDPROTECT»
	}


	«LET this.structure.appWindow.appArea.onInitCommand AS onInitAction»
	«IF onInitAction != null»
    «EXPAND actionImplJavaFiles::actionStructureInit1(this) FOR onInitAction»
    «ENDIF»
	«ENDLET»
}
«ENDFILE»
«ENDDEFINE»


«REM»Genera la Action di Struts che gestisce l'azione di Logout«ENDREM»
«DEFINE struts2LogoutJavaFile(boolean skip_component_dir_creation) FOR GUIModel»
«FILE getStrutsLogoutJavaFile(this, skip_component_dir_creation)»package «getPresentationJavaPackage(this)»;

import java.util.*;

import «getDTOBaseJavaPackage(this)».*;

/**
 * «getStrutsLogoutClassName(this)» Action Class.
 *
 * @author GuiGen
 */
public class «getStrutsLogoutClassName(this)» extends «getStrutsBaseActionClassName(this)» {

    
    /**
	 * nessuna classe model associata
	 */
	public Class modelClass() {
		return null;
	}
    
    
    
	/**
	 *
	 * @return SSO_LOGOUT.
	 */
	public String ssoLogout() throws Exception {
		
		log.debug("[«getStrutsLogoutClassName(this)»::ssoLogout] START");
		
		invalidateLocalSession();
		log.debug("[«getStrutsLogoutClassName(this)»::ssoLogout] START");
		return "SSO_LOGOUT";
	}

	
	/**
	 *
	 * @return LOCAL_LOGOUT.
	 */
	public String localLogout() throws Exception {
		
		log.debug("[«getStrutsLogoutClassName(this)»::localLogout] START");
		invalidateLocalSession();
		log.debug("[«getStrutsLogoutClassName(this)»::localLogout] START");
		return "LOCAL_LOGOUT";
	}


	/**
	 * Invalida gli attributi di autenticazione contenuti in sessione
	 */
	protected void invalidateLocalSession(){
		«IF securityModel!=null && securityModel.autenticationMethod!=null»
		session.remove(«getIrideIdAdapterFilterFQN()».AUTH_ID_MARKER);
		session.remove(«getIrideIdAdapterFilterFQN()».IRIDE_ID_SESSIONATTR);
		«ENDIF»
	}
	

}
«ENDFILE»
«ENDDEFINE»


«REM»
==========================================================================================================================
STRUTS2 ACTIONS FILES
===========================================================================================================================
«ENDREM»

«REM»Mappa un ContentPanel con una Action Struts«ENDREM»
«DEFINE actionJavaFile(GUIModel model, boolean skip_component_dir_creation) FOR ContentPanel»
«FILE getStrutsActionJavaFile(this, model, skip_component_dir_creation)»package «getPresentationJavaPackage(model)»;

import java.util.*;

import org.apache.struts2.interceptor.validation.SkipValidation;

import com.opensymphony.xwork2.Preparable;
import com.opensymphony.xwork2.validator.annotations.*;

import «getDTOBaseJavaPackage(model)».*;
«IF ((GUIModel)(this.eRootContainer)).securityModel!=null-»
import «getSecurityJavaPackage(model)».*;
«ENDIF-»
import «getBaseJavaPackage(model)».business.*;

/**
 * «getStrutsActionClassName(this)» Action Class.
 *
 * @author GuiGen
 */
@Validation()
public class «getStrutsActionClassName(this)» extends «getStrutsBaseActionClassName(model)» 
	implements Preparable{

    «EXPAND actionImplJavaFiles::widgetsProperties(model, true) FOR this»
	«EXPAND actionImplJavaFiles::storedAppDataProperties(model, true) FOR this»
	«EXPAND actionImplJavaFiles::commonProperties FOR this»
	/**
	 * classe model associata
	 */
	public Class modelClass(){
		return «getModelDTOFQN(this, false, false, model)».class;
	}
 
 	«LET getAllEventSourceWidgets() AS allEventSources»
	«REM»«LET allEventSources.select(w|((Widget)w).eventHandlers.select(eh|eh.eventType==EventTypes::CLICKED).size>0) AS allClickSources»«ENDREM»
	/**
	 * I singoli eventi sui singoli widget sono gestiti dai metodi specifici
	 * @return SUCCESS.
	 */
	@SkipValidation
	public String execute() throws Exception {
		return SUCCESS;
	}
	
	//////////////////////////////////////////////////////////////////////////////////
	/// metodi specifici per la gestione del singolo tipo di evento sul singolo widget
	/// contenuto nel contentPanel
	/// metodo: handle<nomeWidget>_<NOME_EVENTO>
	/// es: handletreeVoci_CLICKED
	//////////////////////////////////////////////////////////////////////////////////
	«FOREACH allEventSources AS currEventSource»
	«LET (Widget)currEventSource AS currEventWidget»
	«FOREACH currEventWidget.eventHandlers AS currEventHandler»
	/**
	 * Gestione dell'evento CLICKED sul widget [«currEventWidget.name»]
	 */
	«IF currEventHandler.skipValidation-»
	@SkipValidation
	«ENDIF-»
	public String «getHandlerMethodName(currEventWidget, currEventHandler)»()
		throws Exception
	{
		ICommand action = initCommand("«(currEventWidget).name»","«currEventHandler.eventType»");
		if (log.isDebugEnabled()){
				log.debug("[«getStrutsActionClassName(this)»::«getHandlerMethodName(currEventWidget, currEventHandler)»] dump model before");
				dumpModel(false);
		}
		String result = action.doCommand(this);
		if (result != null) {
			if (log.isDebugEnabled()){
				log.debug("[«getStrutsActionClassName(this)»::«getHandlerMethodName(currEventWidget, currEventHandler)»] dump model after");
				dumpModel(false);
				log.debug("[«getStrutsActionClassName(this)»::«getHandlerMethodName(currEventWidget, currEventHandler)»] returning result [" + result + "]");
			}
			return result;
		} else {
			if (log.isDebugEnabled()){
				log.debug("[«getStrutsActionClassName(this)»::«getHandlerMethodName(currEventWidget, currEventHandler)»] dump model after");
				dumpModel(false);
				log.debug("[«getStrutsActionClassName(this)»::«getHandlerMethodName(currEventWidget, currEventHandler)»] returning default result [SUCCESS]");
			}
			return SUCCESS;
		}
	}
	«ENDFOREACH»
	«ENDLET»
	«ENDFOREACH»
	
	«ENDLET»
	
	/**
	 * Gestione della validazione
	 */
	public void validate() {
		«PROTECT CSTART '/*' CEND '*/' ID getRegionUID(getStrutsActionClassName(this) + "_validate")»
		/* Inserire la validazione */
		«ENDPROTECT»
	}
	
	«IF model.securityModel.autenticationMethod!=null»
	protected Map<String, UISecConstraint> allVisibilityConstraints = null;
	protected Map<String, UISecConstraint> allOnOffConstraints = null;
	«ENDIF»
	
	/**
	 * Metodo di preparazione della schermata/action
	 */
	public void prepare() throws Exception{
	    super.prepare();
	    «IF model.securityModel.autenticationMethod!=null»
	    // caricamento struttura di constraints
	    if (allVisibilityConstraints==null)
	    	allVisibilityConstraints = getPageVisibilityUIConstraints();
	    if (allOnOffConstraints==null)
	    	allOnOffConstraints = getPageONOFFUIConstraints();
	    «ENDIF»
		      
		«IF this.onRefreshCommand!=null»
		// comandi eseguiti ad ogni refresh
		ICommand cmd = initOnRefreshCommand();
		String res= cmd.doCommand(this);
		«ENDIF»
	}
	
	«IF model.securityModel.autenticationMethod!=null»
	«EXPAND security::securedWidgetCheck(model) FOR this»
	«ENDIF»
	
	«LET this.onRefreshCommand AS onRefreshAction»
	«IF onRefreshAction != null»
    «EXPAND actionImplJavaFiles::actionStructureInit2(model) FOR onRefreshAction»
    «ENDIF»
	«ENDLET»
	
	«IF model.securityModel.autenticationMethod!=null»
	«EXPAND security::getPageUIConstraintDef(model) FOR this»
	«ENDIF»
	
	/**  */
	void dumpModel(boolean pre) {
		log.debug("[«getStrutsActionClassName(this)»::dumpmodel] START");
			
		
		log.debug("[«getStrutsActionClassName(this)»::dumpmodel] #### DUMP del model della action "+this.getClass()+(pre?" prima dell'azione":" dopo l'azione"));
		log.debug("[«getStrutsActionClassName(this)»::dumpmodel] [a] campi pubblici del model");
		try {
			java.beans.BeanInfo bi = java.beans.Introspector.getBeanInfo(this.getClass());
			java.beans.PropertyDescriptor[] props = bi.getPropertyDescriptors();
			for (int i = 0; i < props.length; i++) {
				java.beans.PropertyDescriptor pd = props[i];
				java.lang.reflect.Method m = pd.getReadMethod();
				if (m != null) {
					Object pval = m.invoke(this, new Object[]{});
					log.debug("[«getStrutsActionClassName(this)»::dumpmodel] "+pd.getName() + ":" + pval);
				}
			}
		}
		catch(Exception e) {
			log.error("[«getStrutsActionClassName(this)»::dumpmodel] Errore nel dump"+e+", ignoro");
		}
		log.debug("[«getStrutsActionClassName(this)»::dumpmodel] [b] stato dei widget");
		Object cpWidgetStatus = session.get("«this.name»");
		log.debug("[«getStrutsActionClassName(this)»::dumpmodel] "+cpWidgetStatus);
		log.debug("[«getStrutsActionClassName(this)»::dumpmodel] [c] sessione");
		log.debug("[«getStrutsActionClassName(this)»::dumpmodel] "+session);
	}
	

	«REM»Espande la struttura della InitAction«ENDREM»
    «EXPAND actionImplJavaFiles::actionStructureInit(model) FOR this»
    
    /*
     * [DM] GESTIONE TEMPORANEA DEL CAMBIO TAB
     * TODO: sostituire con la logica vera
     */
    
    private String selectedTabKey;
    
    public void setSelectedTabKey(String value) {
		selectedTabKey = value;
	}

	public String getSelectedTabKey() {
		return selectedTabKey;
	}
    
    
    private String selectedTabValue;
    
    public void setSelectedTabValue(String value) {
		selectedTabValue = value;
	}

	public String getSelectedTabValue() {
		return selectedTabValue;
	}
    
    @SkipValidation
    public String handleChangeTab() throws Exception {
    	session.put(selectedTabKey, selectedTabValue);
    	return SUCCESS;
    }

}
«ENDFILE»
«ENDDEFINE»


«REM»
==========================================================================================================================
STRUTS2 CUSTOM DECORATORS CLASSES
===========================================================================================================================
«ENDREM»
«DEFINE strutsCustomDecoratorsJavaFiles(boolean skip_component_dir_creation) FOR GUIModel»

	«REM»Validatori custom definiti dal generatore«ENDREM»
	«FOREACH (List[ContentPanel])getAllContentPanels(this) AS currCP»
		«LET findAllWidgetsInContentPanel(currCP).typeSelect(Table) AS allTables»
			«EXPAND tableDecoratorJavaFile(this) FOREACH allTables»
		«ENDLET»
	«ENDFOREACH»
«ENDDEFINE»

«DEFINE tableDecoratorJavaFile(GUIModel model) FOR Table»
«IF customDecorator»
«FILE getTableDecoratorJavaFile(model, this)»package «getPresentationJavaPackage(model)»;

«PROTECT CSTART '/*' CEND '*/' ID getRegionUID(getTableDecoratorClassName(this)+"Decorator.import")»
/// inserire qui eventuali import aggiuntive
«ENDPROTECT»

import org.displaytag.decorator.TableDecorator;

public class «getTableDecoratorClassName(this)» extends TableDecorator {

	
	public «getTableDecoratorClassName(this)»() {
		super();
		
	}

«PROTECT CSTART '/*' CEND '*/' ID getRegionUID(getTableDecoratorClassName(this)+"Decorator.body")»
    /// Questo spazio e' destinato alla definizione del Decorator.
    /// La documentazione sull'utilizzo dei decoratori della display tag e' disponibile all'url:
    /// http://displaytag.sourceforge.net/1.2  
«ENDPROTECT»

}

«ENDFILE»
«ENDIF»
«ENDDEFINE»



«REM»
==========================================================================================================================
STRUTS2 CUSTOM VALIDATORS CLASSES
===========================================================================================================================
«ENDREM»

«REM»Crea le classi dei validatori custom di Struts 2 definiti«ENDREM»
«DEFINE strutsCustomValidatorsJavaFiles(boolean skip_component_dir_creation) FOR GUIModel»

	«REM»Validatori custom definiti dal generatore«ENDREM»
	«EXPAND strutsCsiDateValidatorJavaFile(skip_component_dir_creation) FOR this»
	
	«REM»Validatori custom modellati dall'utente«ENDREM»
	«FOREACH (List[String])getUserCustomValidatorsName() AS currValidator»
		«EXPAND strutsCustomValidatorJavaFile(currValidator, skip_component_dir_creation) FOR this»
	«ENDFOREACH»

«ENDDEFINE»


«REM»Crea la struttura di un validatore custom di Struts 2 come definito dall'utente. 
Spettera' all'utente inserire nelle regioni protette il codice del validatore«ENDREM»
«DEFINE strutsCustomValidatorJavaFile(String validatorName, boolean skip_component_dir_creation) FOR GUIModel»
«FILE getStrutsCustomValidatorJavaFile(validatorName, this, skip_component_dir_creation)»package «getValidationJavaPackage(this)»;

import com.opensymphony.xwork2.validator.ValidationException;
import com.opensymphony.xwork2.validator.validators.FieldValidatorSupport;

«PROTECT CSTART '/*' CEND '*/' ID getRegionUID(validatorName + ".import")»
/* Inserire qui gli altri import necessari al validatore */
«ENDPROTECT»

/**
 * «validatorName.toUpperCase()» Custom Validation Class.
 *
 * @author GuiGen
 */
public class «validatorName.toUpperCase()» extends FieldValidatorSupport {

	@Override
	public void validate (Object object) throws ValidationException {
		«PROTECT CSTART '/*' CEND '*/' ID getRegionUID(validatorName + ".validate")»
		/* Inserire qui il codice che implementa la logica del validatore */
		
		// nome del campo
		String fieldName = getFieldName();

		// valore del campo, come generico Object da castare nel tipo desiderato/atteso
		Object value = this.getFieldValue(fieldName, object);

		«ENDPROTECT»
	}
	
	«PROTECT CSTART '/*' CEND '*/' ID getRegionUID(validatorName + ".other")»
	/* Inserire qui proprieta' e metodi del validatore */
	«ENDPROTECT»
}
«ENDFILE»
«ENDDEFINE»


«REM»Crea un validatore custom di Struts 2 per la gestione delle date«ENDREM»
«DEFINE strutsCsiDateValidatorJavaFile(boolean skip_component_dir_creation) FOR GUIModel»
«LET ((List[String])getGuigenCustomValidators()).get(0) AS validatorName»
«FILE getStrutsCustomValidatorJavaFile(validatorName, this, skip_component_dir_creation)»package «getValidationJavaPackage(this)»;

import java.text.SimpleDateFormat;

import com.opensymphony.xwork2.validator.ValidationException;
import com.opensymphony.xwork2.validator.validators.FieldValidatorSupport;

/**
 * Controlla che la data sia nel formato atteso.
 *
 * @author GuiGen
 */
public class «validatorName.toFirstUpper()» extends FieldValidatorSupport {

	/** Formato atteso della data (obbligatorio) */
	private String format;


	public String getFormat() {
		return format;
	}
	public void setFormat(String format) {
		this.format = format;
	}


	public void validate(Object object) throws ValidationException {
		// nome del campo
		String fieldName = getFieldName();

		// valore del campo
		String value = (String) this.getFieldValue(fieldName, object);

		if ( format == null || format.trim().length() == 0 ) {
			throw new ValidationException("Nessun formato specificato");
		} else {
			if ( value != null && value.trim().length() > 0 ) {
				SimpleDateFormat sdf = new SimpleDateFormat(format);
				try {
					sdf.parse(value);
				} catch (Exception e) {
					addFieldError(fieldName, object);
				}
			}
		}
	}

}
«ENDFILE»
«ENDLET»
«ENDDEFINE»
